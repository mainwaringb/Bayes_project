---
title: "Class Paper - Introduction to Bayesian Statistics"
author: "Ben Mainwaring"
date: "3/31/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r}
#Run an initial script to load data files, and do some light restructuring and merging
#Previous recoding has already been done in SPSS
#Because Bayesian take so long to run, I have executed them in separate files

source("Scripts/6A - Hierarchical Model - Prep.R")
library(rjags)
library(MCMCvis)
library(knitr) #Need to load the knitr library in order to use kable for table-formatting

load("Data/JAGS Output - pre-full imp.RData")
load("Data/JAGS Output - post-full imp.RData")
load("Data/Covariance + Mean - pre-full imp.RData")

options(scipen = 999)
```

```{r}
#Do some further DP to generate objects used below

#Generate named summary objects, for easier reference
summ.pre_miss <- summary(jags_out.pre_miss)
summ.post_miss <- summary(jags_out.post_miss)

#Estimate marginal effect of age
age_seq <- seq(from = 18, to = 90)
mfx.age.post <- data.frame(age = age_seq, pred = age_seq * summ.post_miss$statistics[4,1] + (age_seq ^ 2) * summ.post_miss$statistics[5,1])
mfx.age.pre <- data.frame(age = age_seq, pred = age_seq * summ.pre_miss$statistics[4,1] + (age_seq ^ 2) * summ.pre_miss$statistics[5,1])


```

Introductory summary paragraph here...

## Motivation

### Background

The rise of right-populist parties is arguably the most important shift in European politics over the past decade. This is an important empirical shift, as it has disrupted long-standing patterns of party competition and models of voting behaviour. It is also an important normative shift. For many people with broadly liberal political views, right-populist parties are a threat to be countered. Immigration is often seen as one of the issues driving the rise of right-populist parties; if this is true, minimising anti-immmigrant sentiment might weaken these parties' standing. Governments that are opposed to (or threatened by) right-populists challengers could conceivably craft immigration and integration policy in a way that minimises sympathy for right-populist parties.

It is relatively clear that many right-populist parties have rhetorically mobilized against immigration, and that many right-populist supporters cite immigration as a top issue. However, it is less clear how exposure to diversity actually affect support for right-populist parties. Political commentary and academic research have generally suggested two hypotheses, the "threat" and "contact" hypotheses.[^1] These posit roughly opposite effects, and potentially suggest different strategies for countering right-populist movements.

The "threat" hypothesis suggests that exposure to immigrants breeds resentment amongst the non-immigrant and non-minority population, especially if resources (such as jobs or government funding) are perceived to be scarce. This implies that exposure to diversity increases support for right-populist parties. For example, people who live in more diverse towns will (all else equal) be more supportive of right-populist parties. The "contact" hypothesis, by contrast, suggests that exposure to immigrants can foster understanding, dialogue, and tolerance - at least when resources are relatively abundant. The contact hypothesis suggests that exposure to diversity should decrease support for right-populist parties. People who live in more diverse towns would, all else equal, be less supportive of these parties.

The relative strength of "threat" and "contact" effects, in a given place and time, have potentially important policy implications. To simplify (and perhaps oversimplify), a strong "contact" effect suggests that increasing immigration, and ensuring immigrants are geographically distributed, can minimise support for right-populist parties. A strong "threat" effect suggests that restricting immigration, and perhaps concentrating immigration geographically, is a more effective strategy for countering right-populist parties. If the balanced between these two effects are contingent and contextual, policymaking must be appropriately nuanced. Policy is likely to fail without good research behind it.

Understanding the balance between these two effects is methodologically challenging. Bayesian approaches cannot solve all the methodological challenges, but may be useful in addressing some of them. This paper takes very simple Bayesian approach to measure the relationship between exposure to diversity and support for right-populist parties, testing the threat and contact hypotheses. It is a "toy" paper, designed only to illustrate a statistical approach. It does *not* adequately address other methodological issues, such as selection effects and conceptually approrpiate measurement of the variables. As such, its findings should not be taken seriously. However, it might serve as a base for "serious" future research.

### Use of Bayesian Methods

Assessing the strength of threat and contact effects is methodologically challenging for many reasons. These challenges go beyond technical statistical issues. They include defining and measuring exposure to immigrants (what counts as "exposure"? who counts as an "immigrant"?), and addressing selection bias (political attitudes might affect exposure to immigrants, as well as vice versa). However, the statistical models needed to explore the issue are at least moderately complex, and can benefit from Bayesian estimation in several ways.

First, Bayesian estiamtion is technically convenient for many models used to explore the subject. "Exposure to immigrants" is often measured using geographic proximity to immigrants as a (flawed) proxy; this involves a hierarchical/multilevel model that relates individual-level attitudes or behaviours to neighbourhood- or municipal-level demographic composition. Bayesian estimation is common for hierarchical/multilevel models.[^2] The underlying theory of hierarchical models also fits well with Bayesian theory, because both assume that observed parameters are drawn from underlying distributions.

Second, a Bayesian approach allows for the incorporation of prior information into a model. Given the massive volume of research and popular commentary on right-populist parties, this is potentially valuable - a new analysis of right-populist support does not exist in a vacuum. Information on the drivers of right-populist support in one context (a given election, or a given country) can be used to more precisly estimate drivers in a different context. While the balance between threat and contact effects is debated, there is relative clarity about some other correlates of right-populist voting. For example, most politically-aware Europeans (or political scientists) would probably anticipate that right-populist support is associated with lower levels of education. Incorporating all relevant information can help build a good model, and formalising background background knowledge helps do this.

Bayesian estimation can also easily accomodate missing data patterns which are likely to occur when analysing right-populist parties. Political preferences are sensitive, and some people refuse to disclome them in surveys; the people who refuse to answer sensitive questions are likely to be systematically different from those who do. If missingness is a function of observed data, [^3] Bayesian techniques can easily produce valid and precise estimates. They are particularly flexible when the missing data is on a dependent variable, as in a model that predicts party favourability.


##Methodology

### Case Study

I measure the relationship between exposure to immigrants and support for right-populist parties, primarily using Bayesian estimation but contrasing this with maximum-likelihood estimation. My case study is the Alternative for Deutschland (AfD), the main right-populist party in Germany, at the time of the German 2017 federal elections. The case selection is mostly arbitrary. However, Germany is the European Union's largest country (by population and economy), and the success or failure of right-populist parties in Germany arguably has particular importance for the rest of the world and continent. Germany is also one of Europe's most ethnically diverse countries, and the center of the post-2015 immigration wave. 

Attitudinal data is taken from the 2017 cross-sectional components of the German Longitudinal Election Study (GLES), a publicly-available, reputable source of opinion data.[^4] Fieldwork in the GLES was conducted face-to-face using, using a nationally representative sampling frame. Because the GLES includes both pre- and post-election waves, it is easy to incorporate prior information without compiling data from multiple sources. Most of the analysis focuses on the post-election wave (how people *actually* voted), but priors for this wave were set based on analysis of the pre-election wave. I combine the German Election Study with data on the German election constituencies, obtained from the Federal Returing Officer (elections office) of the German government.[^5] 

### Variables and Hypotheses

The literature suggests two possible relationships between right-populist support and exposure to immigrants: the threat hypothesis suggests a negative association, while the contact hypothesis suggests a positive one. A third, null, hypothesis suggests that there is no discernible relationship.

    Ha[threat]: positive association between exposure to immigrants and support for AfD
    Ha[contact]: negative association between exposure to immigrants and support for AfD
    H0: no association

The key dependent variable is favourability towards AfD, which is measured on a 0-to-10 scale. Because it is a continuous variable, it is mathematically and computationally easier to model than vote. Theories that link exposure to immigrants with *voting* focus on attitudes to the right-populist parties. As such, exposure to immigrants will likely have very similar effects on party favourability and vote intent. Attitudes towards the AfD are extremely polarised in both waves - a vast majority of the population appears to strongly oppose the party while a small minority support it.

```{r, cache = TRUE, fig.align = 'center', fig.height = 4}
par(mfrow = c(1,2), oma = c(0,0,1.5,0), mar = c(5.1, 4.1, 2.1, 2.1))
hist(preSurvey.merged$Fav_AfD, main = '', xlab = "AfD favourability (pre-election)", ylim = c(0,1000), las = 1)
#axis(side = 2, at = c(0, 200, 400, 600, 800, 1000), labels = c(0, 200, 400, 600, 800, 1000), las = 1)
hist(postSurvey.merged$Fav_AfD, main = '', xlab = "AfD favourability (post-election)", ylim = c(0,1000), las = 1)
mtext("Distribution of AfD Support, German Population", side = 3, outer = TRUE, cex = 1.2, font = 2)
```

Exposure to immigrants is measured using a proxy of local immigrant population, as is common in the literature - specifically, the proportion of the local population with a migration background. so this is a widely-used proxy. "Local" is defined as a parliamentary constituency (wahlkreis); there are a total of `r nrow(kreiseData)` constituencies in Germany. In an average constituency, about `r round(mean(kreiseData$MigrantBackground_Yes_Pct))`% of the population has a migrant background, as seen below. While constituencies vary somewhat in size, the total proportion German residents with a backgrond remains `r round(sum(kreiseData$Pop_Total_Count * kreiseData$MigrantBackground_Yes_Pct) / sum(kreiseData$Pop_Total_Count))`%. 

```{r, cache = TRUE, fig.align = 'center', fig.height = 4, fig.width = 4}
par(mar = c(5.1, 4.1, 3.6, 2.1))
hist(kreiseData$MigrantBackground_Yes_Pct, main = 'Migrant Background by Constituency',
     xlab = "% of population with migrant background")
```

To isolate the effect of exposure to immigrants, it is necessary to include a number of control variables at both the individual and constituency level. The proportion of immigrants in a constituency is likely to vary with other socioeconomic character. The model therefore controls for constituency GDP per capita, unemployment rate, education levels (proportion of the adult population with university entracne qualificaitons), and age structure (proportion of the population aged 60 or above). Good measurement also requires separating the effect of an individiual's *own* demographic characteristics. The model includes individual parallels to the constituency-level variables described above: education, income, and employment status. It also includes a group-level control for constituency AfD vote share in 2017: it is not very interesting to say that people in AfD-supporting constituencies are more pro-AfD, so this control is necessary. Education was coded with dummies for "low" and "medium" education levels; income was coded as a quasi-continuous 13-level variable; and age was treated as a continuous variable, including a quadratic term. [^6]


### Model Specification

To formally test the above hypotheses, I build a multilevel random-intercepts model. Use i to denote individual survey respondents, and j to denote constituencoes, so that j|i denotes the constituency for the ith respondent. Gamma and Beta are vectors of coefficients, while X[l0] and X[l1] are matrices of the individual-level ("level-0") and group-level ("level-1") independent variables.

    y[i] = BX[l0, i] + alpha[j|i] + epsilon[i]
    alpha[j] = GammaX[l1, j] + tau[j]
    y[i] = BetaX[l0, i] + GammaX[l1, j] + epsilon[i] + tau[j]
    
which is equivalent to specifying:
    
    y[i,j]|X[l0, i], X[l1, j] ~ N(BetaX[l0, i] + GammaX[l1, j],  epsilon[i] + tau[j])

The hypotheses focuses on a specific element of gamma, namely Gamma[migrants]. Using the above notation:
    
    Ha[threat]: Gamma[migrants] > 0
    Ha[contact]: Gamma[migrants] < 0
    H0: Gamma[migrants] =0
    
Data is missing on a substantial number of cases for two variables: the dependent variables (support for AfD), and one independent variable (income). Missing data was handled during the estimation process. Income is estimated in JAGS based on other individual-level variables, excluding age (age was excluded due to computational issues; a model that imputed based on group-level variables would be an interesting extension). There were also a trivial number of missing observations (`r sum(is.na(preSurvey.merged$age))`) for age, which were imputed using the same process.

Models were estimated in JAGS, mostly called from R using the `rjags` package. R and rjags were used for diagnostics on the Markov Chain Monte Carlo, and for other data visualisation and summary. Some initial data processing was done in SPSS.


###Prior Specification

My analysis centres on the post-election wave of the GLES data. To generate priors for this, I first draw upon the pre-election wave of GLES. Incorporating this prior information into the model allows, at least in theory, for narrower standard errors and more precise estimation. It also partially formalises the intuition that exist around right-populist parties: it is widely believed, for example, that these parties generally perform better amongst poorer, less-educated, and older people and amongst men.

Priors for the post-election model were therefore specified using a multivariate normal distribution, based on the poseteriors means and covariance matrix from the pre-election survey. Covariances for both Beta and Gamma coeffiients were combined into a single covariance matrix. This choice was guided partially by theory, and partially by practically. The pre-election data (below) show high covariance between constituency-level Gamma variables, and between a few elements of Beta and Gamma - as well very high covariance between Beta[age] and Beta[age^2^]. Under these circumstances, at least some multivariate normal specifications seem useful; they have *potential* to speed model estimation and incorporate useful prior knowledge into the analysis. Specifying all variables as part of a multivariate distribution was judged as more practical than specifying an esoteric mix of univariate and multivariate priors.

Because it is possible that substantive in the electorate occurred between the two waves of survey, it would not be appropriate to *completely* copy the posteriors covariances. I instead multiply these covariances by 1.5, to discount past information and allow for the possibility of changing effect over time. Changing this adjustment, by making it broader or narrower, could be a useful robustness check on the model.

The pre-election survey itself requires priors. For control variables, these were loose guesses, specified in the form of univariate normal distributions. Univariate distirbutions were chosen because there was no clear information that would suggest correlated estimates of Beta and Gamma; given this, univariate normal distributions were expected to be computationally easier and produce narrower posteriors. I expected that the AfD would perform better in poorer and less-educated constituencies, with higher unemployed and a more elderly population; likewise, I expected that AfD would be viewed more positively by poorer, less-educated, and unemployed people, and by men. 

These expectations were codified using loose rules of thumb for both the constituency and individual level. Priors for Gamma (at the constituency level) assumed that a shift from the 25th and 75th percentiles of the IV would correspond with a 1-point shift in the DV. [^7] Priors on individual-level variables (Beta) used a similar rule of thumb: each variable mwould have an approximately 1-point effect. [^8] Standard deviations on the priors were intentionally broad, to reflect that they were no more than educated guesses. 

**can these be moved into multiple columns, as well as prettified?**

    Gamma[migrant.yes] ~ N(0.0, 0.25)
    Gamma[income.high] ~ N(-0.1, 0.25)
    Gamma[educ.high] ~ N(-0.1, 0.25)
    Gamma[unemp] ~ N(0.25, 0.625)
    Gamma[age.60+] ~ N(0.2, 0.5)
    Gamma[AfDshare] ~ N(0.33, 0.68)
    
    Beta[educ.low] ~ N(1.0, 5.0)
    Beta[educ.med] ~ N(0.5, 5.0)
    Beta[gend.male] ~ N(1.0, 5.0)
    Beta[age] ~ N(0.0, 0.2)
    Beta[age^2^] ~ N(0.0, 0.2)
    Beta[unemp^ ~ N(1.0, 5.0)
    Beta[income] ~ N(-0.1, 1.0)

For comparison, I also test entirely uninformative priors (setting the mean to zero and standard deviation to 100 for all variables). The results when using uninformative priors are only trivially different, so they are not reported here.

## Application

###Estimation of Priors with Pre-Election Wave

The pre-election model was computed with three Markov Chains. It was run over 50,000 iterations, using a thinning factor of 25, following a 10,000-iteration burn-in period. The model converges well on most variables. However, the strong autocorrelation between Beta[age] and Beta[age^2^] causes some issues. The difference between naive and time-series standard errors for these two variables is `r round(mean(summary(jags_out.pre_miss)$statistics[c(4:5), 4] / summary(jags_out.pre_miss)$statistics[c(4:5), 3]), 1)`x, compared with `r round(mean(summary(jags_out.pre_miss)$statistics[-c(4:5), 4] / summary(jags_out.pre_miss)$statistics[-c(4:5), 3]), 1)`x for other variables in the model. These can be seen in both the traces (which show very slow change between iterations), and the autocorrelation plots (which show very high dependence, even with thinning at n = 25).


```{r, fig.align = 'center', fig.height = 8, fig.width = 10}
par(mfrow = c(2,2))
plot(jags_out.pre_miss[,4], trace = TRUE, density = FALSE, main = "Trace of B[age]", auto.layout = FALSE)
plot(jags_out.pre_miss[,5], trace = TRUE, density = FALSE, main = "Trace of B[age ^ 2]", auto.layout = FALSE)
autocorr.plot(jags_out.pre_miss[[1]][,4], main = "Autocorrelation of B[age]", sub = "chain 1, thin = 25", auto.layout = FALSE)
autocorr.plot(jags_out.pre_miss[[1]][,5], main = "Autocorrelation of B[age ^ 2]", sub = "chain 1, thin = 25", auto.layout = FALSE)
```

If this model were my main focus, I might have run with a longer number of iterations and higher thinning paramenter. However, the primary goal of analysing pre-election data is to generate a prior for use with post-election data. A quick initial run is sufficient for this purpose; narrow  standard errors on coefficient estimates are not particularly important. Even with this initial run, the credibility interval for age and age ^2^ lies outside zero, as shown in the output below.

```{r, results = 'asis'}
#Plot table of individual-level coefficients
kable(summ.pre_miss$quantiles[c(1:7),c(1,3,5)], 
      caption = "Estimates of Beta coefficients", digits = 4)
```


All individual-level variables have estimated effects with credibility intervals outside zero. Most effects were also in the expected direction: men, older people, the poorer, and the less-educated are more likely to support AfD. However, the coefficient for unemployment is signed in the opposite direction as expected: people who are unemployed (or live with an unemployed person) are *less* supportive of AfD. This finding could warrant further exploration. The curve relating age to AfD favourability was also somewhat surprising. Contrary to received wisdom, it suggested that *younger* Germans are more supportive of the AfD, after controlling for other variables. Support for the AfD, at the mean Beta, peaks at `r mfx.age.pre$age[mfx.age.pre$pred == max(mfx.age.pre$pred)]` after  controlling for other variables. 

```{r, results = 'asis'}
kable(summ.pre_miss$quantiles[c(8:12),c(1,3,5)],
      caption = "Estimates of Gamma coefficients", digits = 4)
```

The effects of wakhlkreise-level variables are more surprising. Only two of the five variables have credibility intervals that lay entirely outside zero. This might be explained by the smaller number of observations for wahlkreise, or by the substantively smaller influence of constituency-level variabes: your neighbours' age, gender, and socioeconomic status are likely to have a smaller effect than your own personal status. One of the two nonzero Gamma coefficients (age) is in the expected direction: older parliamentary constituencies are more pro-AfD. The other (income) runs in an unexpected direction: wealthier parliamentary constituencies are also more pro-AfD. The finding regarding income does not fit easily with either threat or contact hypotheses runs contrary to both the contact and threat hypotheses. The contact the hypothesis would predict little relationship between constituency wealth and political views, while the threat hypothesis might expect that economically-secure communities would worry less about migrants.

<!-- **Do I need to display these tables, given that my ultimate focus is on the post-election model?** -->

<!-- ```{r, results = 'asis'} -->
<!-- #coda.samples stores each markov chain as a separate list - use do.call("rbind"...) to convert them to a single data frame -->
<!-- jags_dfout.pre_miss <-  do.call("rbind", jags_out.pre_miss) -->

<!-- #Calculate the correlation and covariance matrix (correlation for easy display, covariance to feed in to priors of a future model) -->
<!-- #And format nicely -->
<!-- corr.pre_miss <- cor(jags_dfout.pre_miss) -->
<!-- cov.pre_miss <- cov(jags_dfout.pre_miss) -->

<!-- #View correlations -->
<!-- kable(corr.pre_miss[1:7,1:7], caption = "Correlations between Beta parameters in posterior", digits = 2) -->

<!-- kable(corr.pre_miss[8:12,8:12], caption = "Correlations between Beta parameters in posterior", digits = 2) -->

<!-- #to fix table output, try kableExtra -->
<!-- #https://community.rstudio.com/t/kableextra-how-to-create-a-table-with-equal-column-width/4386 -->
<!-- #http://haozhu233.github.io/kableExtra/awesome_table_in_html.html -->

<!-- ``` -->

The covariance between coefficients is generally low amongst individual-level Beta coefficients, high amongst constituency-level Gamma coefficients, and very high between Beta[age] and Beta[age^2^]. [^9] This suggests that, in specifying the priors for use with post-election data, at least some multivariate normal distributions are necessary. In particular multivariate prior distributions on the gamma coefficients, and on the beta coefficients relating to age, are likely to provide useful information. This might in theory help speed estimation, although it was not ultimately clear that it did so.


###Estimation of Model with Post-Election Wave

**Auto-update parameters**The post-election model was calculated with 1 million iterations and a thinning parameter of 125, following a 35,000-iteration burn-in period. Initial diangnostics, run on a much shorter Markov Chain, suggested this was neccessary to handle severe autocorrelation problems. Even with a very long model estimation, autocorrelation was an issue for Gamma parameters, and the Beta parameters related to age, as shown below (autocorrelations plots are arbitrarily taken from the first chain, but all chains show a similar pattern). 

```{r, fig.align = 'center', fig.height = 8, fig.width = 10}
par(mfrow = c(4,2))
autocorr.plot(jags_out.post_miss[[1]][,c(4:5)], auto.layout = FALSE)
autocorr.plot(jags_out.post_miss[[1]][,c(8:13)], auto.layout = FALSE)

```

While severe autocorrelation persisted, the Markov chains were clearly better mixed than in the pre-election model. The trace of Beta[age^2^] (below) and Beta[age] still showed autocorrelation, compared with the trace of another variable (Beta[educ.low] is used for reference).[^10] However, there no clear trend line over time, and a *relatively* good mix between the three chains. The density plots for all parameters, including the troublemaking age parameters, were smooth and approximately normally distributed.

```{r, fig.align = 'center', fig.height = 4, fig.width = 10}
plot(jags_out.post_miss[,c(1,5)], trace = TRUE, density = FALSE)
```

An even longer run of the Markov chain might resolve these problems. This might require the use of parallelization and distributed computing. Alternatively, it might be pragmatic to drop the quadratic age term. Age could instead be specified as a categorical variable, with categories implied by the findings of a simple linear regression with quadratic term. For present purposes, I accept the Markov Chain shown above as "good enough."

##Findings
###Constituency-level variables
The number of migrants in an area appears to have virtually no relationship with favourability towards AfD. This challenges *both* the threat and contact hypotheses outlined above. The results of this analysis should not be taken "seriously," as discussed above, since they ignore important methodological concerns. Were these results to be taken seriously, however, they would suggest that immigrants are *not* a direct of driver of support for right populist-parties. The results would likely suggest that broader cultural anxieties, not the direct presence of immigrants or minorities, fuel right-populist success.

```{r, fig.align = 'center', fig.height = 4, fig.width = 7}
#visualise posterior vs prior for Gamma[migrant.yes]
#use MCMCtrace function, since it enables the plotting of priors against posteriors - but we first need to draw from the distribution of priors
prior_draws <- rnorm(15000, mean =  summ.pre_miss$statistics[8,1], sd = sqrt(cov.pre_miss[8,8] * 1.5))

MCMCtrace(jags_out.post_miss, params = "G\\[migrant.yes\\]", type = "density", priors = prior_draws,
          main_den = "Prior and Posterior Density for G[migrant.yes]", lty_pr = "dashed", xlim = c(-0.06, 0.06),
          PPO_out = FALSE,
          ISB = FALSE, pdf = FALSE)
```

Given that these results are somewhat surprising, I considered whether an incorrectly specified prior might be at fault. There would be little justification for setting a different prior *mean*, given that coefficients in the pre-election analysis were very robusrt to different priors. There could be a stronger case for setting a difference prior *variance*. The post-election survey suggests a coefficient above zero, while the pre-election survey suggests an effect below zero. Reducing the influence of the prior might lead to a coefficient whose credibility interval is above zero. However, given the long estimation time for this model, I was unable to explore alternate priors fully.

```{r, fig.align = 'center', fig.height = 5, fig.width = 10}
#visualise all gammas
par(mfrow = c(1,2))
MCMCplot(jags_out.post_miss[,c(8:13)], ref_ovl = TRUE, xlim = c(-.20, .20), main = "Post-Election", sz_ax = 1.5) 
MCMCplot(jags_out.pre_miss[,c(8:13)], ref_ovl = TRUE, xlim = c(-.20, .20), main = "Pre-Election", sz_ax = 1.5) 

```

Other constituency-level variables show unexpected but relatively strong patterns, as shown above. While the presence of immigrants in a constituency does not predict support for AfD, the presence of older people does predict AfD support. People who live in parliamentary constituencies with an older population are more pro-AfD, even after controlling for their own age. It is possible that this relationship is spurious: East German constituencies may have both an older population and more right-populist leanings. However, it is also possible that these findings reflect something substantive. 

Two substantive possibilities seem likely. In older communities, concerns about the pace of cultural change from immigration might be more salient. These concerns could easily affect even younger people within older communities - they can be disseminated by local media and informal social networks in a way that affects all residents of an older community.

Alternatively, older communities might be more worried about or affected by the economic consequences of immigration. Older workers, with fewer years before retirement, face a different calculation about re-training or relocating in response to labour market pressures. Places with an older workforce might therefore be affected differently by immigration, in a way that affects young and old alike. This could include challenges to public finances and tax revenue; impact on wages and prices; or network effects that impact local firms' competitiveness. If the association between constituency age structure and view on AfD is genuine, and not a statistical artifact, this might lend support to an indirect of the threat hypothesis. However, the exact mechanisms here are unclear, and would need much more extensive theorizing.

Analysis of the post-election survey also finds an unexpected *negative* relationship between AfD vote in a constituency and an individual's favourability towards AfD. People in AfD-supporting communities are, on average, *less* favourable to the AfD. This seems illogical. It is possible that this result represents some statistical fluke, or the ommmission of a needed control variable. However, assuming the result is genuine, it might represent a pattern of polarisation. In places where the AfD is weak, it is less threatening -- and people are more likely to hold "soft" views towards it. [^11] While this paper assumed that AfD favourability would be a useful proxy for vote, and could ease model estimations, these findings challenge that assumption. It might be worth specifying a model with (reported) vote as the dependent, to test this assumption. 

###Individual-level variables

```{r}
#Merge pre- and post-election output into a matrix
beta.compare <- cbind(summ.post_miss$statistics[c(1:7),c(1:2)],  summ.pre_miss$statistics[c(1:7),c(1:2)])
colnames(beta.compare) <- c("Post-Election Mean", "Post-Election SD", "Pre-Election Mean", "Pre-Election SD")
```

The effects of individual-level variables are mostly stable from pre- to post-election surveys. The estimated effect of household unemployment was notably smaller in the post-election survey, and the curve relating age to AfD favourability was somewhat different. However, posterior means were otherwise very similar. Standard deviations in the post-election shrunk by a relatively consistent factor, on average `r round(mean((beta.compare[,4] - beta.compare[,2]) / beta.compare[,4]), 2)`.


```{r, results = 'asis'}
kable(beta.compare, digits = 3)
```

While the effect of variables is stable between pre- and post-election waves, the effect of age continues to be somewhat unexpected. The age of peak AfD support is slightly older in the post-election survey, but only slightly (`r which.max(mfx.age.post$pred) + 17
` years old, at the mean Beta). This runs against popular perceptions that the AfD's base is older Germans. Given the difficulties with estimating coefficients for age, I view this result with a degree of skepticism -- it may be a statistical artifact. Re-estimating these models with a simpler, categorical age specification would be a useful robustness check. However, there may also be a substantive explanation.

```{r, fig.align = 'center', fig.height = 4, fig.width = 7}
#For each of 8000 iterations * 3 markov chains, generate the predicted value at each age
jags_dfout.post_miss <-  do.call("rbind", jags_out.post_miss)
jags_dfout.pre_miss <-  do.call("rbind", jags_out.pre_miss)
mfx_per_iter.age.post <- apply(jags_dfout.post_miss[,c(4,5)], 
      1, function(x){
          mfx_out <- (age_seq * x[1]) + (age_seq ^ 2 * x[2])
          return(mfx_out)
      })
mfx_per_iter.age.pre <- apply(jags_dfout.pre_miss[,c(4,5)], 
       1, function(x){
           mfx_out <- (age_seq * x[1]) + (age_seq ^ 2 * x[2])
           return(mfx_out)
       })

peak_per_iter.age.post <- apply(mfx_per_iter.age.post, 2, which.max) + 17
peak_per_iter.age.pre <- apply(mfx_per_iter.age.pre, 2, which.max) + 17

peak_density.age.post <- density(peak_per_iter.age.post, bw = 1.5)
peak_density.age.pre <- density(peak_per_iter.age.pre, bw = 1.5)

peak_density.age.pre <- density(peak_per_iter.age.pre, bw = 1.5)
plot(peak_density.age.post, xlim = c(18,40), main = "Distribution of Age of Peak AfD support")
lines(peak_density.age.pre, lty = "dashed", col = "red")
legend(x = "topleft", legend = c("Post-Election", "Pre-Election"),
       lty = c("solid", "dashed"), col = c("black", "red"))

```

The most likely substantive explanation might be be that older *communities*, rather than older *individuals*, lean towards right-populism in Germany? More "extreme" right parties, like Germany's NPD or the United Kingdom's BNP and EDL, are seen to draw support from a base of younger, working-class men. Younger, working-class men in constituencies with aging demographics -- and a social enviorment that views immigrants as threat, regardless of their numbers -- might be the AfD's true core base. These conclusions should not be drawn from a "toy" paper that ignores causal inference problems. However, if similar findings were to occur under a more robust inference strategy, they would raise interesting questions.


##Conclusions

Dolor sapiente consequatur aut error dolorem ut eum. Qui quod molestiae ut. Delectus libero quis ut placeat. Similique delectus dolores vitae nemo. Dolores officiis cum et reprehenderit perferendis iusto.

[^1]: I am not writing for an academic audience here, and have limited time, so will not include full citations in this paper.

[^2]: The popular Gelman and Hill textbook on multilevel models, for example, uses a Bayesian framework.

[^3]: "Missing at random", in the missing-data terminology popularised by Rubin.

[^4]: Information on the GLES is available at http://gles.eu/wordpress/english/. Data is availabe from https://www.gesis.org/en/elections-home/gles/data/ (files ZA6800, ZA6801, ZA6802). Although face-to-face research is generally seen as a "gold standard," one caveat is that fieldwork for both pre- and post-eleciton waves was conducted over a time period of more than 2 months. It is possible that vote intent/recall might shift over this period, in ways that affect findings.

[^5]: Constituency data was downloaded from https://www.bundeswahlleiter.de/en/dam/jcr/f7566722-a528-4b18-bea3-ea419371e300/btw17_strukturdaten.csv. A description of the dataset is available from https://www.bundeswahlleiter.de/en/bundestagswahlen/2017/strukturdaten.html. Most data comes from underlying sources between 2015 and 2017, and was compiled by a combination of federal and state statistics offices; it is generally survey rather than census data, although presumably conducted to a high standard.

[^6]: "Low" education include Hauptschule graduates, and those who have not completed secondary school; "Medium" include Reaclschule graduates. Income is coded as "below 500 euros/month", then in 250 euro bands between until 1500/month, 500 euro bands until 3000/month, 1000 euro bands until 5000/month, 25000 euro bands until 10000/month, and a final "over 10000 euros/month" category.

[^7]: For example, the difference between the 25th and 75th percentile in unemployment is around 4 points. The prior assumes that a one-point rise in unemployment would correspond with a 0.25-point rise in AfD favorability, so a four-point rise in unemployment would correspond with a 1.0-point rise.

[^8]: This translates to mean 1.0 for the male, unemployed, and low-education dummy variables;  mean 0.5 for the medium-education dummy variable; and mean 0.1 for the income variable scaled from 1 to 13.

[^9]: Correlations *between* Beta and Gamma are generally weak - the main exception was Gamma[age], which was notably correlated with both B[education] variables, both B[age] variables, and B[income]. Priors for the post-election model were estimated using a full covariance matrix, including both Beta and Gamma coefficients.

[^10]: The use of a multivariate normal prior, rather multiple univariate normal priors, was intended to speed convergence and increase accuracy. It is not clear whether this achieved its intended purpose. Benchmarking speed and autocorrelation under several model specifications would be an interesting excercise; however, it is beyond the scope of the present paper. 

[^11]: Related to this, polarisation might also relate to social desirability bias. Constituencies might have *either* a small number of vocal AfD activists, or a larger number of "soft" supports (susceptible to social desirability bias). Measured AfD support might be higher in places where it has only a small number of dedicated activists.

